<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Learning from Examples &raquo; k-means Clustering (cudaFlow) | Taskflow QuickStart</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="m-dark+documentation.compiled.css" />
  <link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <span id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">
        <a href="https://taskflow.github.io"><img src="taskflow_logo.png" alt="" />Taskflow</a> <span class="m-breadcrumb">|</span> <a href="index.html" class="m-thin">QuickStart</a>
      </span>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path id="m-doc-search-icon-path" d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="pages.html">Handbook</a></li>
            <li><a href="namespaces.html">Namespaces</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="3">
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
            <li class="m-show-m"><a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path" />
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          <span class="m-breadcrumb"><a href="Examples.html">Learning from Examples</a> &raquo;</span>
          k-means Clustering (cudaFlow)
        </h1>
        <nav class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li><a href="#DefineTheKMeansKernels">Define the k-means Kernels</a></li>
            <li><a href="#DefineTheKMeanscudaFlow">Define the k-means cudaFlow</a></li>
            <li><a href="#RepeatTheExecutionofTheKMeanscudaFlow">Repeat the Execution of the k-means cudaFlow</a></li>
            <li><a href="#KMeanscudaFlowBenchmarking">Benchmarking</a></li>
          </ul>
        </nav>
<p>Following up on <a href="kmeans.html" class="m-doc">k-means Clustering</a>, this page studies how to accelerate a k-means workload on a GPU using <a href="classtf_1_1cudaFlow.html" class="m-doc">tf::<wbr />cudaFlow</a>.</p><section id="DefineTheKMeansKernels"><h2><a href="#DefineTheKMeansKernels">Define the k-means Kernels</a></h2><p>Recall that the k-means algorithm has the following steps:</p><ul><li>Step 1: initialize k random centroids</li><li>Step 2: for every data point, find the nearest centroid (L2 distance or other measurements) and assign the point to it</li><li>Step 3: for every centroid, move the centroid to the average of the points assigned to that centroid</li><li>Step 4: go to Step 2 until converged (no more changes in the last few iterations) or maximum iterations reached</li></ul><p>We observe Step 2 and Step 3 of the algorithm are parallelizable across individual points for use to harness the power of GPU:</p><ol><li>for every data point, find the nearest centroid (L2 distance or other measurements) and assign the point to it</li><li>for every centroid, move the centroid to the average of the points assigned to that centroid.</li></ol><p>At a fine-grained level, we request one GPU thread to work on one point for Step 2 and one GPU thread to work on one centroid for Step 3.</p><pre class="m-code"><span class="c1">// px/py: 2D points</span>
<span class="c1">// N: number of points</span>
<span class="c1">// mx/my: centroids</span>
<span class="c1">// K: number of clusters</span>
<span class="c1">// sx/sy/c: storage to compute the average</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">assign_clusters</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">mx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">my</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Make global loads once.</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">px</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">best_dance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">best_k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">mx</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="n">my</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">best_d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">best_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">best_k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sx</span><span class="p">[</span><span class="n">best_k</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sy</span><span class="p">[</span><span class="n">best_k</span><span class="p">],</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="w"> </span><span class="p">[</span><span class="n">best_k</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// mx/my: centroids, sx/sy/c: storage to compute the average</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compute_new_means</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">mx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">my</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span><span class="w">  </span><span class="c1">// turn 0/0 to 0/1</span>
<span class="w">  </span><span class="n">mx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">my</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span></pre><p>When we recompute the cluster centroids to be the mean of all points assigned to a particular centroid, multiple GPU threads may access the sum arrays, <code>sx</code> and <code>sy</code>, and the count array, <code>c</code>. To avoid data race, we use a simple <code>atomicAdd</code> method.</p></section><section id="DefineTheKMeanscudaFlow"><h2><a href="#DefineTheKMeanscudaFlow">Define the k-means cudaFlow</a></h2><p>Based on the two kernels, we can define the cudaFlow for the k-means workload below:</p><pre class="m-code"><span class="c1">// N: number of points</span>
<span class="c1">// K: number of clusters</span>
<span class="c1">// M: number of iterations</span>
<span class="c1">// px/py: 2D point vector </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">kmeans_gpu</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">cconst</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">py</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_mx</span><span class="p">,</span><span class="w"> </span><span class="n">h_my</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_px</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_py</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_c</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">h_mx</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">h_px</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">h_my</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">h_py</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// create a taskflow graph</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Executor</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Taskflow</span><span class="w"> </span><span class="n">taskflow</span><span class="p">(</span><span class="s">&quot;K-Means&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// allocate GPU memory</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_px</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_px&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_py</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_py&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_mx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_mx&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_my</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_my&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_sy&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">allocate_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"> </span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_c</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;allocate_c&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// transfer data from the host to the GPU</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">h2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">tf</span><span class="o">::</span><span class="n">cudaFlow</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d_px</span><span class="p">,</span><span class="w"> </span><span class="n">h_px</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">N</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;h2d_px&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d_py</span><span class="p">,</span><span class="w"> </span><span class="n">h_py</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">N</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;h2d_py&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">h_mx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;h2d_mx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">h_my</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;h2d_my&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;h2d&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// GPU task graph of the main k-means body</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">kmeans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">tf</span><span class="o">::</span><span class="n">cudaFlow</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_c</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_c&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_sx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_sy&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">kernel</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1024-1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="n">assign_clusters</span><span class="p">,</span><span class="w"> </span><span class="n">d_px</span><span class="p">,</span><span class="w"> </span><span class="n">d_py</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">d_c</span><span class="w"></span>
<span class="w">    </span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;cluster&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">new_centroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">kernel</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">compute_new_means</span><span class="p">,</span><span class="w"> </span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">d_c</span><span class="w"></span>
<span class="w">    </span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;new_centroid&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">cluster</span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">new_centroid</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">zero_c</span><span class="p">,</span><span class="w"> </span><span class="n">zero_sx</span><span class="p">,</span><span class="w"> </span><span class="n">zero_sy</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;update_means&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// condition task to check convergence</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;converged?&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// transfer the result of clusters from GPU to host</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">tf</span><span class="o">::</span><span class="n">cudaFlow</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">h_mx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;d2h_mx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cf</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">h_my</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;d2h_my&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;d2h&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// deallocated GPU memory</span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](){</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_px</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_py</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_mx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_my</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_sx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_sy</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;free&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// build up the dependency</span>
<span class="w">  </span><span class="n">h2d</span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">allocate_px</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_py</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_mx</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_my</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">kmeans</span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">allocate_sx</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_sy</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_c</span><span class="p">,</span><span class="w"> </span><span class="n">h2d</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">condition</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">condition</span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">kmeans</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">stop</span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">free</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// dump the taskflow without expanding GPU task graphs</span>
<span class="w">  </span><span class="n">taskflow</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// run the taskflow</span>
<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">taskflow</span><span class="p">).</span><span class="n">wait</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// dump the entire taskflow</span>
<span class="w">  </span><span class="n">taskflow</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span></pre><p>The first dump before executing the taskflow produces the following diagram. The condition tasks introduces a cycle between itself and <code>update_means</code>. Each time it goes back to <code>update_means</code>, the cudaFlow is reconstructed with captured parameters in the closure and offloaded to the GPU.</p><div class="m-graph"><svg style="width: 61.750rem; height: 18.188rem;" viewBox="0.00 0.00 987.77 290.77">
<g transform="scale(1 1) rotate(0) translate(4 286.7696)">
<title>Taskflow</title>
<g class="m-node m-flat">
<title>p0x562f9807bcc0</title>
<ellipse cx="79.196" cy="-264.3848" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="79.196" y="-260.5848">allocate_px</text>
</g>
<g class="m-node">
<title>p0x562f9807b550</title>
<polygon points="296.6381,-200.3848 293.6381,-204.3848 272.6381,-204.3848 269.6381,-200.3848 242.6381,-200.3848 242.6381,-164.3848 296.6381,-164.3848 296.6381,-200.3848"/>
<text text-anchor="middle" x="269.6381" y="-178.5848">h2d</text>
</g>
<g class="m-edge">
<title>p0x562f9807bcc0&#45;&gt;p0x562f9807b550</title>
<path d="M123.9292,-249.5537C135.2678,-245.5261 147.3584,-240.9961 158.3919,-236.3848 183.9292,-225.7118 211.9589,-212.0935 233.494,-201.2033"/>
<polygon points="235.2762,-204.2234 242.5986,-196.5662 232.0993,-197.9858 235.2762,-204.2234"/>
</g>
<g class="m-node">
<title>p0x562f9807b440</title>
<polygon points="512.8843,-118.3848 509.8843,-122.3848 488.8843,-122.3848 485.8843,-118.3848 380.8843,-118.3848 380.8843,-82.3848 512.8843,-82.3848 512.8843,-118.3848"/>
<text text-anchor="middle" x="446.8843" y="-96.5848">update_means</text>
</g>
<g class="m-edge">
<title>p0x562f9807b550&#45;&gt;p0x562f9807b440</title>
<path d="M296.8087,-173.5399C311.0243,-168.6538 328.6028,-162.2022 343.8843,-155.3848 365.2031,-145.874 388.184,-133.7906 407.0178,-123.3736"/>
<polygon points="408.8795,-126.3428 415.9049,-118.4122 405.4673,-120.2307 408.8795,-126.3428"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807bbb0</title>
<ellipse cx="79.196" cy="-209.3848" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="79.196" y="-205.5848">allocate_py</text>
</g>
<g class="m-edge">
<title>p0x562f9807bbb0&#45;&gt;p0x562f9807b550</title>
<path d="M144.7354,-200.0929C173.9202,-195.9552 207.2384,-191.2315 232.119,-187.7041"/>
<polygon points="232.8192,-191.1399 242.2289,-186.2707 231.8366,-184.2092 232.8192,-191.1399"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807baa0</title>
<ellipse cx="79.196" cy="-154.3848" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="79.196" y="-150.5848">allocate_mx</text>
</g>
<g class="m-edge">
<title>p0x562f9807baa0&#45;&gt;p0x562f9807b550</title>
<path d="M146.3387,-164.2565C175.1992,-168.4998 207.8389,-173.2987 232.2831,-176.8926"/>
<polygon points="231.8198,-180.362 242.2225,-178.354 232.8381,-173.4365 231.8198,-180.362"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b990</title>
<ellipse cx="79.196" cy="-99.3848" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="79.196" y="-95.5848">allocate_my</text>
</g>
<g class="m-edge">
<title>p0x562f9807b990&#45;&gt;p0x562f9807b550</title>
<path d="M127.9571,-113.9624C138.2634,-117.772 148.8896,-122.2696 158.3919,-127.3848 176.5505,-137.1597 177.2773,-145.5287 195.3919,-155.3848 207.085,-161.7469 220.5835,-167.1658 232.8377,-171.4422"/>
<polygon points="231.7466,-174.7678 242.3404,-174.623 233.9686,-168.1298 231.7466,-174.7678"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b880</title>
<ellipse cx="269.6381" cy="-128.3848" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="269.6381" y="-124.5848">allocate_sx</text>
</g>
<g class="m-edge">
<title>p0x562f9807b880&#45;&gt;p0x562f9807b440</title>
<path d="M332.6276,-118.4342C344.9543,-116.4869 358.005,-114.4253 370.7076,-112.4186"/>
<polygon points="371.4684,-115.8419 380.7997,-110.8243 370.3761,-108.9276 371.4684,-115.8419"/>
</g>
<g class="m-node">
<title>p0x562f9807b330</title>
<polygon points="666.8843,-126.3848 558.8843,-100.3848 666.8843,-74.3848 774.8843,-100.3848 666.8843,-126.3848"/>
<text text-anchor="middle" x="666.8843" y="-96.5848">converged?</text>
</g>
<g class="m-edge">
<title>p0x562f9807b440&#45;&gt;p0x562f9807b330</title>
<path d="M512.9084,-102.9654C518.9851,-103.1357 525.0482,-103.2806 530.8843,-103.3848 540.7133,-103.5602 550.9415,-103.5993 561.1792,-103.5417"/>
<polygon points="561.4363,-107.0398 571.4057,-103.4534 561.3758,-100.04 561.4363,-107.0398"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b770</title>
<ellipse cx="269.6381" cy="-73.3848" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="269.6381" y="-69.5848">allocate_sy</text>
</g>
<g class="m-edge">
<title>p0x562f9807b770&#45;&gt;p0x562f9807b440</title>
<path d="M333.1274,-83.0561C345.3548,-84.9187 358.2781,-86.8873 370.8558,-88.8033"/>
<polygon points="370.4359,-92.2796 380.849,-90.3256 371.4901,-85.3595 370.4359,-92.2796"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b660</title>
<ellipse cx="269.6381" cy="-18.3848" rx="68.6788" ry="18.2703"/>
<text text-anchor="middle" x="269.6381" y="-14.5848">allocate_c</text>
</g>
<g class="m-edge">
<title>p0x562f9807b660&#45;&gt;p0x562f9807b440</title>
<path d="M311.2388,-33.0507C321.9799,-37.1152 333.4521,-41.7041 343.8843,-46.3848 364.7809,-55.7606 387.3825,-67.4302 406.0749,-77.5199"/>
<polygon points="404.456,-80.6235 414.9126,-82.3291 407.8019,-74.4749 404.456,-80.6235"/>
</g>
<g class="m-edge">
<title>p0x562f9807b330&#45;&gt;p0x562f9807b440</title>
<path stroke-dasharray="5,2" d="M614.6579,-86.9249C589.3949,-81.9914 558.6053,-78.2888 530.8843,-81.3848 528.349,-81.6679 525.7784,-81.9978 523.1886,-82.3668"/>
<polygon points="522.4625,-78.9382 513.138,-83.9685 523.5642,-85.851 522.4625,-78.9382"/>
<text text-anchor="middle" x="535.8843" y="-86.5848">0</text>
</g>
<g class="m-node">
<title>p0x562f9807b220</title>
<polygon points="874.8843,-118.3848 871.8843,-122.3848 850.8843,-122.3848 847.8843,-118.3848 820.8843,-118.3848 820.8843,-82.3848 874.8843,-82.3848 874.8843,-118.3848"/>
<text text-anchor="middle" x="847.8843" y="-96.5848">d2h</text>
</g>
<g class="m-edge">
<title>p0x562f9807b330&#45;&gt;p0x562f9807b220</title>
<path stroke-dasharray="5,2" d="M775.0471,-100.3848C787.7308,-100.3848 799.9329,-100.3848 810.6039,-100.3848"/>
<polygon points="810.7257,-103.8849 820.7256,-100.3848 810.7256,-96.8849 810.7257,-103.8849"/>
<text text-anchor="middle" x="797.8843" y="-105.5848">1</text>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b110</title>
<ellipse cx="945.8255" cy="-100.3848" rx="33.8824" ry="18.2703"/>
<text text-anchor="middle" x="945.8255" y="-96.5848">free</text>
</g>
<g class="m-edge">
<title>p0x562f9807b220&#45;&gt;p0x562f9807b110</title>
<path d="M874.9065,-100.3848C883.1342,-100.3848 892.4042,-100.3848 901.4621,-100.3848"/>
<polygon points="901.5318,-103.8849 911.5317,-100.3848 901.5317,-96.8849 901.5318,-103.8849"/>
</g>
</g>
</svg>
</div><p>The second dump after executing the taskflow produces the following diagram, with all cudaFlows expanded:</p><div class="m-graph"><svg style="width: 90.188rem; height: 50.375rem;" viewBox="0.00 0.00 1442.97 806.38">
<g transform="scale(1 1) rotate(0) translate(4 802.3848)">
<title>Taskflow</title>
<g class="m-cluster">
<title>cluster_p0x562f9807b550</title>
<polygon points="299.8944,-456 299.8944,-699 759.8412,-699 759.8412,-456 299.8944,-456"/>
<text text-anchor="middle" x="529.8678" y="-682.2">cudaFlow: h2d</text>
</g>
<g class="m-cluster">
<title>cluster_p0x562f9807b440</title>
<polygon points="8,-161 8,-349 976.0874,-349 976.0874,-161 8,-161"/>
<text text-anchor="middle" x="492.0437" y="-332.2">cudaFlow: update_means</text>
</g>
<g class="m-cluster">
<title>cluster_p0x562f9807b220</title>
<polygon points="838.9331,-8 838.9331,-141 1338.0874,-141 1338.0874,-8 838.9331,-8"/>
<text text-anchor="middle" x="1088.5103" y="-124.2">cudaFlow: h2d</text>
</g>
<g class="m-node m-flat">
<title>p0x562f9807bcc0</title>
<ellipse cx="534.3991" cy="-725" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="534.3991" y="-721.2">allocate_px</text>
</g>
<g class="m-node">
<title>p0x562f9807b550</title>
<polygon points="751.8412,-555 748.8412,-559 727.8412,-559 724.8412,-555 697.8412,-555 697.8412,-519 751.8412,-519 751.8412,-555"/>
<text text-anchor="middle" x="724.8412" y="-533.2">h2d</text>
</g>
<g class="m-edge">
<title>p0x562f9807bcc0&#45;&gt;p0x562f9807b550</title>
<path d="M594.0696,-713.4707C601.0042,-710.6992 607.696,-707.2621 613.595,-703 663.416,-667.0041 697.56,-601.3253 713.8641,-564.2886"/>
<polygon points="717.0851,-565.6577 717.806,-555.0874 710.6508,-562.9011 717.0851,-565.6577"/>
</g>
<g class="m-node">
<title>p0x562f9807b440</title>
<polygon points="968.0874,-205 965.0874,-209 944.0874,-209 941.0874,-205 836.0874,-205 836.0874,-169 968.0874,-169 968.0874,-205"/>
<text text-anchor="middle" x="902.0874" y="-183.2">update_means</text>
</g>
<g class="m-edge">
<title>p0x562f9807b550&#45;&gt;p0x562f9807b440</title>
<path d="M734.1212,-518.6753C763.3144,-461.0289 853.397,-283.1467 888.1822,-214.4581"/>
<polygon points="891.5038,-215.6459 892.8993,-205.1433 885.259,-212.4833 891.5038,-215.6459"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807bbb0</title>
<ellipse cx="534.3991" cy="-430" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="534.3991" y="-426.2">allocate_py</text>
</g>
<g class="m-edge">
<title>p0x562f9807bbb0&#45;&gt;p0x562f9807b550</title>
<path d="M589.9435,-442.5071C598.0675,-445.1674 606.185,-448.313 613.595,-452 645.2403,-467.7458 676.8307,-493.0309 698.217,-511.9368"/>
<polygon points="696.1161,-514.7545 705.8928,-518.8371 700.7959,-509.5487 696.1161,-514.7545"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807baa0</title>
<ellipse cx="534.3991" cy="-375" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="534.3991" y="-371.2">allocate_mx</text>
</g>
<g class="m-edge">
<title>p0x562f9807baa0&#45;&gt;p0x562f9807b550</title>
<path d="M586.6391,-388.9463C596.0596,-392.694 605.4605,-397.3282 613.595,-403 654.9531,-431.8367 689.632,-479.9603 708.7856,-510.0102"/>
<polygon points="705.9558,-512.0866 714.2216,-518.7144 711.8931,-508.3786 705.9558,-512.0866"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b990</title>
<ellipse cx="534.3991" cy="-780" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="534.3991" y="-776.2">allocate_my</text>
</g>
<g class="m-edge">
<title>p0x562f9807b990&#45;&gt;p0x562f9807b550</title>
<path d="M589.3442,-766.7197C598.0884,-762.9452 606.5571,-758.1302 613.595,-752 672.5437,-700.6545 704.5605,-610.4146 717.6609,-564.9101"/>
<polygon points="721.0733,-565.7025 720.3817,-555.1302 714.3294,-563.8262 721.0733,-565.7025"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b880</title>
<ellipse cx="724.8412" cy="-135" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="724.8412" y="-131.2">allocate_sx</text>
</g>
<g class="m-edge">
<title>p0x562f9807b880&#45;&gt;p0x562f9807b440</title>
<path d="M772.8066,-149.0719C790.6986,-154.3211 811.4134,-160.3983 830.9479,-166.1293"/>
<polygon points="830.1477,-169.542 840.7286,-168.9987 832.1184,-162.8251 830.1477,-169.542"/>
</g>
<g class="m-node">
<title>p0x562f9807b330</title>
<polygon points="1122.0874,-201 1014.0874,-175 1122.0874,-149 1230.0874,-175 1122.0874,-201"/>
<text text-anchor="middle" x="1122.0874" y="-171.2">converged?</text>
</g>
<g class="m-edge">
<title>p0x562f9807b440&#45;&gt;p0x562f9807b330</title>
<path d="M968.1115,-189.5807C974.1882,-189.7509 980.2513,-189.8958 986.0874,-190 1006.1005,-190.3573 1027.6734,-188.8542 1047.611,-186.6768"/>
<polygon points="1048.0316,-190.1515 1057.5609,-185.5211 1047.2239,-183.1983 1048.0316,-190.1515"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b770</title>
<ellipse cx="724.8412" cy="-80" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="724.8412" y="-76.2">allocate_sy</text>
</g>
<g class="m-edge">
<title>p0x562f9807b770&#45;&gt;p0x562f9807b440</title>
<path d="M771.8552,-94.267C781.2336,-98.0548 790.753,-102.6223 799.0874,-108 818.6287,-120.6086 817.9468,-130.4481 836.0874,-145 844.1126,-151.4376 853.1672,-157.7427 861.9393,-163.4302"/>
<polygon points="860.2475,-166.5016 870.5688,-168.8939 863.9921,-160.5873 860.2475,-166.5016"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b660</title>
<ellipse cx="724.8412" cy="-25" rx="68.6788" ry="18.2703"/>
<text text-anchor="middle" x="724.8412" y="-21.2">allocate_c</text>
</g>
<g class="m-edge">
<title>p0x562f9807b660&#45;&gt;p0x562f9807b440</title>
<path d="M775.3217,-37.5228C784.0147,-41.4018 792.3918,-46.4484 799.0874,-53 830.5879,-83.8227 807.9247,-111.1004 836.0874,-145 841.764,-151.8329 848.8482,-157.9159 856.2502,-163.1862"/>
<polygon points="854.7505,-166.391 865.0202,-168.9959 858.6164,-160.5554 854.7505,-166.391"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54000b20</title>
<ellipse cx="363.0488" cy="-647" rx="51.7379" ry="18.2703"/>
<text text-anchor="middle" x="363.0488" y="-643.2">h2d_px</text>
</g>
<g class="m-edge">
<title>p0x7fbc54000b20&#45;&gt;p0x562f9807b550</title>
<path d="M402.4556,-635.0187C472.8322,-613.6213 619.169,-569.1288 687.8013,-548.2617"/>
<polygon points="689.1865,-551.4988 697.7359,-545.2412 687.1502,-544.8015 689.1865,-551.4988"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54000c00</title>
<ellipse cx="363.0488" cy="-592" rx="51.7379" ry="18.2703"/>
<text text-anchor="middle" x="363.0488" y="-588.2">h2d_py</text>
</g>
<g class="m-edge">
<title>p0x7fbc54000c00&#45;&gt;p0x562f9807b550</title>
<path d="M410.7189,-584.7532C483.7552,-573.6501 621.8088,-552.6631 687.8415,-542.6247"/>
<polygon points="688.4396,-546.0741 697.8,-541.1108 687.3875,-539.1536 688.4396,-546.0741"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54000ce0</title>
<ellipse cx="363.0488" cy="-537" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="363.0488" y="-533.2">h2d_mx</text>
</g>
<g class="m-edge">
<title>p0x7fbc54000ce0&#45;&gt;p0x562f9807b550</title>
<path d="M418.3911,-537C493.0194,-537 623.9037,-537 687.7312,-537"/>
<polygon points="687.7463,-540.5001 697.7463,-537 687.7463,-533.5001 687.7463,-540.5001"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54000db0</title>
<ellipse cx="363.0488" cy="-482" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="363.0488" y="-478.2">h2d_my</text>
</g>
<g class="m-edge">
<title>p0x7fbc54000db0&#45;&gt;p0x562f9807b550</title>
<path d="M413.3545,-489.6475C486.9235,-500.8315 622.1966,-521.3959 687.5534,-531.3315"/>
<polygon points="687.3835,-534.8458 697.796,-532.8886 688.4356,-527.9253 687.3835,-534.8458"/>
</g>
<g class="m-edge">
<title>p0x562f9807b330&#45;&gt;p0x562f9807b440</title>
<path stroke-dasharray="5,2" d="M1047.8441,-166.817C1027.7619,-165.7918 1006.0593,-165.7695 986.0874,-168 983.5521,-168.2832 980.9815,-168.613 978.3917,-168.982"/>
<polygon points="977.6656,-165.5534 968.3411,-170.5837 978.7673,-172.4662 977.6656,-165.5534"/>
<text text-anchor="middle" x="991.0874" y="-173.2">0</text>
</g>
<g class="m-node">
<title>p0x562f9807b220</title>
<polygon points="1330.0874,-107 1327.0874,-111 1306.0874,-111 1303.0874,-107 1276.0874,-107 1276.0874,-71 1330.0874,-71 1330.0874,-107"/>
<text text-anchor="middle" x="1303.0874" y="-85.2">h2d</text>
</g>
<g class="m-edge">
<title>p0x562f9807b330&#45;&gt;p0x562f9807b220</title>
<path stroke-dasharray="5,2" d="M1180.777,-163.0727C1197.2124,-158.5767 1214.763,-152.6433 1230.0874,-145 1246.5411,-136.7935 1262.9573,-124.6449 1276.0432,-113.7585"/>
<polygon points="1278.4019,-116.3467 1283.7312,-107.1898 1273.8548,-111.0247 1278.4019,-116.3467"/>
<text text-anchor="middle" x="1253.0874" y="-139.2">1</text>
</g>
<g class="m-node m-flat">
<title>p0x7fbc540051d0</title>
<ellipse cx="70.4472" cy="-297" rx="48.1667" ry="18.2703"/>
<text text-anchor="middle" x="70.4472" y="-293.2">zero_c</text>
</g>
<g class="m-node">
<title>p0x7fbc540053d0</title>
<polygon points="270.8944,-232 203.8944,-232 199.8944,-228 199.8944,-196 266.8944,-196 270.8944,-200 270.8944,-232"/>
<polyline points="266.8944,-228 199.8944,-228 "/>
<polyline points="266.8944,-228 266.8944,-196 "/>
<polyline points="266.8944,-228 270.8944,-232 "/>
<text text-anchor="middle" x="235.3944" y="-210.2">cluster</text>
</g>
<g class="m-edge">
<title>p0x7fbc540051d0&#45;&gt;p0x7fbc540053d0</title>
<path d="M99.5568,-282.3523C124.7601,-269.6703 161.6151,-251.1251 190.5793,-236.5506"/>
<polygon points="192.3215,-239.5921 199.6811,-231.9706 189.175,-233.3391 192.3215,-239.5921"/>
</g>
<g class="m-node">
<title>p0x7fbc54005470</title>
<polygon points="595.3991,-218 477.3991,-218 473.3991,-214 473.3991,-182 591.3991,-182 595.3991,-186 595.3991,-218"/>
<polyline points="591.3991,-214 473.3991,-214 "/>
<polyline points="591.3991,-214 591.3991,-182 "/>
<polyline points="591.3991,-214 595.3991,-218 "/>
<text text-anchor="middle" x="534.3991" y="-196.2">new_centroid</text>
</g>
<g class="m-edge">
<title>p0x7fbc540053d0&#45;&gt;p0x7fbc54005470</title>
<path d="M271.1644,-212.3252C318.3482,-210.1159 402.4684,-206.1773 462.9297,-203.3463"/>
<polygon points="463.3484,-206.8307 473.1737,-202.8667 463.0209,-199.8383 463.3484,-206.8307"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54005270</title>
<ellipse cx="70.4472" cy="-242" rx="54.3945" ry="18.2703"/>
<text text-anchor="middle" x="70.4472" y="-238.2">zero_sx</text>
</g>
<g class="m-edge">
<title>p0x7fbc54005270&#45;&gt;p0x7fbc540053d0</title>
<path d="M119.4902,-233.6749C141.7072,-229.9035 167.8201,-225.4708 189.6301,-221.7686"/>
<polygon points="190.3627,-225.1943 199.6359,-220.0701 189.1912,-218.2931 190.3627,-225.1943"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54005330</title>
<ellipse cx="70.4472" cy="-187" rx="54.3945" ry="18.2703"/>
<text text-anchor="middle" x="70.4472" y="-183.2">zero_sy</text>
</g>
<g class="m-edge">
<title>p0x7fbc54005330&#45;&gt;p0x7fbc540053d0</title>
<path d="M119.4902,-195.0278C141.7072,-198.6644 167.8201,-202.9388 189.6301,-206.5089"/>
<polygon points="189.2018,-209.9853 199.6359,-208.1467 190.3327,-203.0772 189.2018,-209.9853"/>
</g>
<g class="m-edge">
<title>p0x7fbc54005470&#45;&gt;p0x562f9807b440</title>
<path d="M595.5281,-197.8387C658.6546,-195.6068 757.3062,-192.1189 825.5728,-189.7053"/>
<polygon points="825.9669,-193.1936 835.8369,-189.3424 825.7195,-186.198 825.9669,-193.1936"/>
</g>
<g class="m-node m-flat">
<title>p0x562f9807b110</title>
<ellipse cx="1401.0286" cy="-89" rx="33.8824" ry="18.2703"/>
<text text-anchor="middle" x="1401.0286" y="-85.2">free</text>
</g>
<g class="m-edge">
<title>p0x562f9807b220&#45;&gt;p0x562f9807b110</title>
<path d="M1330.1096,-89C1338.3373,-89 1347.6073,-89 1356.6652,-89"/>
<polygon points="1356.7349,-92.5001 1366.7348,-89 1356.7348,-85.5001 1356.7349,-92.5001"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc5400bf40</title>
<ellipse cx="902.0874" cy="-89" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="902.0874" y="-85.2">d2h_mx</text>
</g>
<g class="m-edge">
<title>p0x7fbc5400bf40&#45;&gt;p0x562f9807b220</title>
<path d="M957.4238,-89C1040.3949,-89 1194.8496,-89 1265.7533,-89"/>
<polygon points="1265.9913,-92.5001 1275.9913,-89 1265.9912,-85.5001 1265.9913,-92.5001"/>
</g>
<g class="m-node m-flat">
<title>p0x7fbc54008020</title>
<ellipse cx="902.0874" cy="-34" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="902.0874" y="-30.2">d2h_my</text>
</g>
<g class="m-edge">
<title>p0x7fbc54008020&#45;&gt;p0x562f9807b220</title>
<path d="M953.2817,-41.0217C1035.1882,-52.2557 1193.7856,-74.0085 1265.8444,-83.8919"/>
<polygon points="1265.4458,-87.3699 1275.8287,-85.2613 1266.3971,-80.4348 1265.4458,-87.3699"/>
</g>
</g>
</svg>
</div><p>The main cudaFlow task, <code>update_means</code>, must not run before all required data has settled down. It precedes a condition task that circles back to itself until we reach <code>M</code> iterations. When iteration completes, the condition task directs the execution path to the cudaFlow, <code>h2d</code>, to copy the results of clusters to <code>h_mx</code> and <code>h_my</code> and then deallocate all GPU memory.</p></section><section id="RepeatTheExecutionofTheKMeanscudaFlow"><h2><a href="#RepeatTheExecutionofTheKMeanscudaFlow">Repeat the Execution of the k-means cudaFlow</a></h2><p>We observe the GPU task graph parameters remain <em>unchanged</em> across all k-means iterations. In this case, we can leverage <a href="classtf_1_1cudaFlow.html#a99358da15e3bdfa1faabb3e326130e1f" class="m-doc">tf::<wbr />cudaFlow::<wbr />offload_until</a> or <a href="classtf_1_1cudaFlow.html#ac2269fd7dc8ca04a294a718204703dad" class="m-doc">tf::<wbr />cudaFlow::<wbr />offload_n</a> to run it repeatedly without conditional tasking.</p><pre class="m-code"><span class="n">tf</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">kmeans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskflow</span><span class="p">.</span><span class="n">emplace</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">tf</span><span class="o">::</span><span class="n">cudaFlow</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">){</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_c</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_c&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_sx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">zero_sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;zero_sy&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">kernel</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1024-1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">assign_clusters</span><span class="p">,</span><span class="w"> </span><span class="n">d_px</span><span class="p">,</span><span class="w"> </span><span class="n">d_py</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">d_c</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;cluster&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tf</span><span class="o">::</span><span class="n">cudaTask</span><span class="w"> </span><span class="n">new_centroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="n">kernel</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">compute_new_means</span><span class="p">,</span><span class="w"> </span><span class="n">d_mx</span><span class="p">,</span><span class="w"> </span><span class="n">d_my</span><span class="p">,</span><span class="w"> </span><span class="n">d_sx</span><span class="p">,</span><span class="w"> </span><span class="n">d_sy</span><span class="p">,</span><span class="w"> </span><span class="n">d_c</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;new_centroid&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">cluster</span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">new_centroid</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">zero_c</span><span class="p">,</span><span class="w"> </span><span class="n">zero_sx</span><span class="p">,</span><span class="w"> </span><span class="n">zero_sy</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// we ask the executor to launch the cudaFlow by M times</span>
<span class="w">  </span><span class="n">cf</span><span class="p">.</span><span class="n">offload_n</span><span class="p">(</span><span class="n">M</span><span class="p">);</span><span class="w"></span>
<span class="p">}).</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;update_means&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="c1">// build up the dependency</span>
<span class="n">h2d</span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">allocate_px</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_py</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_mx</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_my</span><span class="p">);</span><span class="w"></span>

<span class="n">kmeans</span><span class="p">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">allocate_sx</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_sy</span><span class="p">,</span><span class="w"> </span><span class="n">allocate_c</span><span class="p">,</span><span class="w"> </span><span class="n">h2d</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span><span class="w"></span>

<span class="n">stop</span><span class="p">.</span><span class="n">precede</span><span class="p">(</span><span class="n">free</span><span class="p">);</span><span class="w"></span></pre><p>At the last line of the cudaFlow closure, we call <code>cf.offload_n(M)</code> to ask the executor to repeatedly run the cudaFlow by <code>M</code> times. Compared with the version using conditional tasking, the cudaFlow here is created only one time and thus the overhead is reduced.</p><div class="m-graph"><svg style="width: 126.938rem; height: 29.312rem;" viewBox="0.00 0.00 2031.25 469.46">
<g transform="scale(1 1) rotate(0) translate(4 465.463)">
<title>Taskflow</title>
<g class="m-cluster">
<title>cluster_p0x55764dbce0d0</title>
<polygon points="161.6604,-223.5391 161.6604,-374.6934 658.6604,-374.6934 658.6604,-223.5391 161.6604,-223.5391"/>
<text text-anchor="middle" x="410.1604" y="-357.8934">cudaFlow: h2d</text>
</g>
<g class="m-cluster">
<title>cluster_p0x55764dbce1e0</title>
<polygon points="1179.6604,-137.1543 1179.6604,-453.463 1545.6604,-453.463 1545.6604,-137.1543 1179.6604,-137.1543"/>
<text text-anchor="middle" x="1362.6604" y="-436.663">cudaFlow: update_means</text>
</g>
<g class="m-cluster">
<title>cluster_p0x55764dbce2f0</title>
<polygon points="1553.6604,-64.7696 1553.6604,-215.5391 1807.6604,-215.5391 1807.6604,-64.7696 1553.6604,-64.7696"/>
<text text-anchor="middle" x="1680.6604" y="-198.7391">cudaFlow: d2h</text>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcd960</title>
<ellipse cx="75.6604" cy="-322.3087" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="75.6604" y="-318.5087">allocate_px</text>
</g>
<g class="m-node">
<title>p0x55764dbce0d0</title>
<polygon points="625.6604,-267.5391 622.6604,-271.5391 601.6604,-271.5391 598.6604,-267.5391 571.6604,-267.5391 571.6604,-231.5391 625.6604,-231.5391 625.6604,-267.5391"/>
<text text-anchor="middle" x="598.6604" y="-245.7391">h2d</text>
</g>
<g class="m-edge">
<title>p0x55764dbcd960&#45;&gt;p0x55764dbce0d0</title>
<path d="M129.7642,-309.3928C139.039,-307.4042 148.6041,-305.4937 157.6604,-303.9239 306.2979,-278.1598 485.1806,-260.023 561.3703,-252.8944"/>
<polygon points="561.7916,-256.3704 571.4256,-251.9619 561.1451,-249.4003 561.7916,-256.3704"/>
</g>
<g class="m-node">
<title>p0x55764dbce1e0</title>
<polygon points="1537.6604,-181.1543 1534.6604,-185.1543 1513.6604,-185.1543 1510.6604,-181.1543 1405.6604,-181.1543 1405.6604,-145.1543 1537.6604,-145.1543 1537.6604,-181.1543"/>
<text text-anchor="middle" x="1471.6604" y="-159.3543">update_means</text>
</g>
<g class="m-edge">
<title>p0x55764dbce0d0&#45;&gt;p0x55764dbce1e0</title>
<path d="M625.7449,-246.8591C743.1065,-235.2459 1210.1323,-189.033 1395.3818,-170.7022"/>
<polygon points="1395.9754,-174.1607 1405.5821,-169.6929 1395.286,-167.1947 1395.9754,-174.1607"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcda70</title>
<ellipse cx="743.6604" cy="-322.3087" rx="75.8212" ry="18.2703"/>
<text text-anchor="middle" x="743.6604" y="-318.5087">allocate_py</text>
</g>
<g class="m-edge">
<title>p0x55764dbcda70&#45;&gt;p0x55764dbce0d0</title>
<path d="M710.3945,-305.6139C687.9076,-294.3286 658.2147,-279.427 635.0909,-267.8221"/>
<polygon points="636.4507,-264.5885 625.9431,-263.2312 633.3108,-270.8448 636.4507,-264.5885"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcdb80</title>
<ellipse cx="916.6604" cy="-322.3087" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="916.6604" y="-318.5087">allocate_mx</text>
</g>
<g class="m-edge">
<title>p0x55764dbcdb80&#45;&gt;p0x55764dbce0d0</title>
<path d="M860.1748,-309.3828C795.4537,-294.5723 691.2274,-270.7217 635.9219,-258.0658"/>
<polygon points="636.3908,-254.5827 625.862,-255.7638 634.8293,-261.4064 636.3908,-254.5827"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcdc90</title>
<ellipse cx="1092.6604" cy="-322.3087" rx="79.3924" ry="18.2703"/>
<text text-anchor="middle" x="1092.6604" y="-318.5087">allocate_my</text>
</g>
<g class="m-edge">
<title>p0x55764dbcdc90&#45;&gt;p0x55764dbce0d0</title>
<path d="M1035.0249,-309.6409C1024.9289,-307.6013 1014.5061,-305.6095 1004.6604,-303.9239 869.6472,-280.8094 707.9657,-261.6903 636.1761,-253.6394"/>
<polygon points="636.1728,-250.1175 625.8466,-252.488 635.3973,-257.0744 636.1728,-250.1175"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcdda0</title>
<ellipse cx="1627.6604" cy="-249.5391" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="1627.6604" y="-245.7391">allocate_sx</text>
</g>
<g class="m-edge">
<title>p0x55764dbcdda0&#45;&gt;p0x55764dbce1e0</title>
<path d="M1588.1167,-233.9408C1575.5894,-228.5679 1561.8382,-222.2114 1549.6604,-215.5391 1534.4048,-207.1804 1518.3241,-196.6954 1504.7529,-187.3061"/>
<polygon points="1506.4274,-184.2055 1496.2309,-181.3276 1502.4072,-189.936 1506.4274,-184.2055"/>
</g>
<g class="m-node">
<title>p0x55764dbce2f0</title>
<polygon points="1643.6604,-108.7696 1640.6604,-112.7696 1619.6604,-112.7696 1616.6604,-108.7696 1589.6604,-108.7696 1589.6604,-72.7696 1643.6604,-72.7696 1643.6604,-108.7696"/>
<text text-anchor="middle" x="1616.6604" y="-86.9696">d2h</text>
</g>
<g class="m-edge">
<title>p0x55764dbce1e0&#45;&gt;p0x55764dbce2f0</title>
<path d="M1507.876,-145.0753C1530.042,-134.0099 1558.3049,-119.9009 1580.4669,-108.8376"/>
<polygon points="1582.172,-111.8983 1589.5558,-104.3003 1579.0454,-105.6353 1582.172,-111.8983"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcdeb0</title>
<ellipse cx="1793.6604" cy="-249.5391" rx="74.4932" ry="18.2703"/>
<text text-anchor="middle" x="1793.6604" y="-245.7391">allocate_sy</text>
</g>
<g class="m-edge">
<title>p0x55764dbcdeb0&#45;&gt;p0x55764dbce1e0</title>
<path d="M1751.9522,-234.2044C1738.9024,-230.0242 1724.3365,-225.9799 1710.6604,-223.5391 1675.3957,-217.2454 1583.6579,-226.8255 1549.6604,-215.5391 1531.7117,-209.5805 1514.0223,-198.2748 1500.0387,-187.6873"/>
<polygon points="1501.8661,-184.6718 1491.8417,-181.2422 1497.5394,-190.1745 1501.8661,-184.6718"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbcdfc0</title>
<ellipse cx="1954.6604" cy="-249.5391" rx="68.6788" ry="18.2703"/>
<text text-anchor="middle" x="1954.6604" y="-245.7391">allocate_c</text>
</g>
<g class="m-edge">
<title>p0x55764dbcdfc0&#45;&gt;p0x55764dbce1e0</title>
<path d="M1916.3654,-234.2577C1903.9049,-229.9696 1889.8776,-225.8502 1876.6604,-223.5391 1840.8594,-217.2791 1584.2951,-226.5547 1549.6604,-215.5391 1531.6381,-209.8071 1513.9418,-198.5227 1499.9726,-187.8908"/>
<polygon points="1501.7999,-184.8734 1491.7869,-181.4107 1497.4551,-190.3618 1501.7999,-184.8734"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258000ba0</title>
<ellipse cx="598.6604" cy="-322.3087" rx="51.7379" ry="18.2703"/>
<text text-anchor="middle" x="598.6604" y="-318.5087">h2d_px</text>
</g>
<g class="m-edge">
<title>p0x7fc258000ba0&#45;&gt;p0x55764dbce0d0</title>
<path d="M598.6604,-303.5687C598.6604,-295.7248 598.6604,-286.4372 598.6604,-277.7946"/>
<polygon points="602.1605,-277.7127 598.6604,-267.7128 595.1605,-277.7128 602.1605,-277.7127"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258000c40</title>
<ellipse cx="477.6604" cy="-322.3087" rx="51.7379" ry="18.2703"/>
<text text-anchor="middle" x="477.6604" y="-318.5087">h2d_py</text>
</g>
<g class="m-edge">
<title>p0x7fc258000c40&#45;&gt;p0x55764dbce0d0</title>
<path d="M504.2144,-306.3391C521.3904,-296.0094 543.9635,-282.4339 562.7344,-271.1451"/>
<polygon points="564.5642,-274.1289 571.33,-265.9756 560.9565,-268.1301 564.5642,-274.1289"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258000dd0</title>
<ellipse cx="352.6604" cy="-322.3087" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="352.6604" y="-318.5087">h2d_mx</text>
</g>
<g class="m-edge">
<title>p0x7fc258000dd0&#45;&gt;p0x55764dbce0d0</title>
<path d="M394.1128,-310.0466C441.0872,-296.151 516.9425,-273.7122 561.888,-260.4168"/>
<polygon points="562.9331,-263.7577 571.5295,-257.5647 560.9474,-257.0452 562.9331,-263.7577"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258000ea0</title>
<ellipse cx="224.6604" cy="-322.3087" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="224.6604" y="-318.5087">h2d_my</text>
</g>
<g class="m-edge">
<title>p0x7fc258000ea0&#45;&gt;p0x55764dbce0d0</title>
<path d="M265.4625,-309.8893C273.1325,-307.7537 281.1131,-305.6648 288.6604,-303.9239 386.1508,-281.4364 502.7713,-263.295 561.2823,-254.7868"/>
<polygon points="562.1156,-258.2029 571.5136,-253.3114 561.1164,-251.2746 562.1156,-258.2029"/>
</g>
<g class="m-node m-flat">
<title>p0x55764dbce400</title>
<ellipse cx="1616.6604" cy="-18.3848" rx="33.8824" ry="18.2703"/>
<text text-anchor="middle" x="1616.6604" y="-14.5848">free</text>
</g>
<g class="m-edge">
<title>p0x55764dbce2f0&#45;&gt;p0x55764dbce400</title>
<path d="M1616.6604,-72.5038C1616.6604,-64.7623 1616.6604,-55.5567 1616.6604,-46.9533"/>
<polygon points="1620.1605,-46.8964 1616.6604,-36.8964 1613.1605,-46.8965 1620.1605,-46.8964"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc2580032e0</title>
<ellipse cx="1489.6604" cy="-401.0782" rx="48.1667" ry="18.2703"/>
<text text-anchor="middle" x="1489.6604" y="-397.2782">zero_c</text>
</g>
<g class="m-node">
<title>p0x7fc2580034e0</title>
<polygon points="1455.1604,-340.3087 1388.1604,-340.3087 1384.1604,-336.3087 1384.1604,-304.3087 1451.1604,-304.3087 1455.1604,-308.3087 1455.1604,-340.3087"/>
<polyline points="1451.1604,-336.3087 1384.1604,-336.3087 "/>
<polyline points="1451.1604,-336.3087 1451.1604,-304.3087 "/>
<polyline points="1451.1604,-336.3087 1455.1604,-340.3087 "/>
<text text-anchor="middle" x="1419.6604" y="-318.5087">cluster</text>
</g>
<g class="m-edge">
<title>p0x7fc2580032e0&#45;&gt;p0x7fc2580034e0</title>
<path d="M1474.1252,-383.5967C1464.8964,-373.2117 1453.0201,-359.8476 1442.7142,-348.2506"/>
<polygon points="1445.141,-345.7124 1435.882,-340.5625 1439.9085,-350.3624 1445.141,-345.7124"/>
</g>
<g class="m-node">
<title>p0x7fc258003580</title>
<polygon points="1506.6604,-267.5391 1388.6604,-267.5391 1384.6604,-263.5391 1384.6604,-231.5391 1502.6604,-231.5391 1506.6604,-235.5391 1506.6604,-267.5391"/>
<polyline points="1502.6604,-263.5391 1384.6604,-263.5391 "/>
<polyline points="1502.6604,-263.5391 1502.6604,-231.5391 "/>
<polyline points="1502.6604,-263.5391 1506.6604,-267.5391 "/>
<text text-anchor="middle" x="1445.6604" y="-245.7391">new_centroid</text>
</g>
<g class="m-edge">
<title>p0x7fc2580034e0&#45;&gt;p0x7fc258003580</title>
<path d="M1426.2213,-303.9458C1429.1069,-295.8697 1432.5586,-286.2087 1435.7474,-277.2839"/>
<polygon points="1439.123,-278.2386 1439.1917,-267.644 1432.5311,-275.8833 1439.123,-278.2386"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258003380</title>
<ellipse cx="1368.6604" cy="-401.0782" rx="54.3945" ry="18.2703"/>
<text text-anchor="middle" x="1368.6604" y="-397.2782">zero_sx</text>
</g>
<g class="m-edge">
<title>p0x7fc258003380&#45;&gt;p0x7fc2580034e0</title>
<path d="M1380.489,-382.8089C1386.9903,-372.7678 1395.1747,-360.1268 1402.3791,-348.9996"/>
<polygon points="1405.399,-350.7753 1407.896,-340.4789 1399.5231,-346.9709 1405.399,-350.7753"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258003440</title>
<ellipse cx="1241.6604" cy="-401.0782" rx="54.3945" ry="18.2703"/>
<text text-anchor="middle" x="1241.6604" y="-397.2782">zero_sy</text>
</g>
<g class="m-edge">
<title>p0x7fc258003440&#45;&gt;p0x7fc2580034e0</title>
<path d="M1274.7237,-386.4469C1302.8779,-373.9879 1343.5913,-355.9712 1374.7036,-342.2032"/>
<polygon points="1376.2982,-345.325 1384.0264,-338.0776 1373.4654,-338.9238 1376.2982,-345.325"/>
</g>
<g class="m-edge">
<title>p0x7fc258003580&#45;&gt;p0x55764dbce1e0</title>
<path d="M1451.1744,-231.2191C1454.6559,-219.6516 1459.2242,-204.4737 1463.1631,-191.3865"/>
<polygon points="1466.6238,-192.0323 1466.1544,-181.4479 1459.9208,-190.0148 1466.6238,-192.0323"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc258005800</title>
<ellipse cx="1744.6604" cy="-163.1543" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="1744.6604" y="-159.3543">d2h_mx</text>
</g>
<g class="m-edge">
<title>p0x7fc258005800&#45;&gt;p0x55764dbce2f0</title>
<path d="M1716.5703,-147.2692C1697.8079,-136.6589 1672.9575,-122.6059 1652.7346,-111.1697"/>
<polygon points="1654.2346,-107.9971 1643.8072,-106.1212 1650.7888,-114.0903 1654.2346,-107.9971"/>
</g>
<g class="m-node m-flat">
<title>p0x7fc2580058a0</title>
<ellipse cx="1616.6604" cy="-163.1543" rx="55.3091" ry="18.2703"/>
<text text-anchor="middle" x="1616.6604" y="-159.3543">d2h_my</text>
</g>
<g class="m-edge">
<title>p0x7fc2580058a0&#45;&gt;p0x55764dbce2f0</title>
<path d="M1616.6604,-144.5135C1616.6604,-136.8556 1616.6604,-127.8146 1616.6604,-119.3544"/>
<polygon points="1620.1605,-119.0966 1616.6604,-109.0967 1613.1605,-119.0967 1620.1605,-119.0966"/>
</g>
</g>
</svg>
</div><p>We can see from the above taskflow the condition task is removed.</p></section><section id="KMeanscudaFlowBenchmarking"><h2><a href="#KMeanscudaFlowBenchmarking">Benchmarking</a></h2><p>We run three versions of k-means, sequential CPU, parallel CPUs, and one GPU, on a machine of 12 Intel i7-8700 CPUs at 3.20 GHz and a Nvidia RTX 2080 GPU using various numbers of 2D point counts and iterations.</p><table class="m-table"><thead><tr><th>N</th><th>K</th><th>M</th><th>CPU Sequential</th><th>CPU Parallel</th><th>GPU (conditional taksing)</th><th>GPU (using offload_n)</th></tr></thead><tbody><tr><td>10</td><td>5</td><td>10</td><td>0.14 ms</td><td>77 ms</td><td>1 ms</td><td>1 ms</td></tr><tr><td>100</td><td>10</td><td>100</td><td>0.56 ms</td><td>86 ms</td><td>7 ms</td><td>1 ms</td></tr><tr><td>1000</td><td>10</td><td>1000</td><td>10 ms</td><td>98 ms</td><td>55 ms</td><td>13 ms</td></tr><tr><td>10000</td><td>10</td><td>10000</td><td>1006 ms</td><td>713 ms</td><td>458 ms</td><td>183 ms</td></tr><tr><td>100000</td><td>10</td><td>100000</td><td>102483 ms</td><td>49966 ms</td><td>7952 ms</td><td>4725 ms</td></tr></tbody></table><p>When the number of points is larger than 10K, both parallel CPU and GPU implementations start to pick up the speed over than the sequential version. We can see that using the built-in predicate, <a href="classtf_1_1cudaFlow.html#ac2269fd7dc8ca04a294a718204703dad" class="m-doc">tf::<wbr />cudaFlow::<wbr />offload_n</a>, can avoid repetitively creating the graph over and over, resulting in two times faster than conditional tasking.</p></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-doc-search-content">
          <form>
            <input type="search" name="q" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" autocomplete="off" spellcheck="false" />
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            <p class="m-noindent">Search for symbols, directories, files, pages or
            modules. You can omit any prefix from the symbol or file path; adding a
            <code>:</code> or <code>/</code> suffix lists all members of given symbol or
            directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">&darr;</span>
            / <span class="m-label m-dim">&uarr;</span> to navigate through the list,
            <span class="m-label m-dim">Enter</span> to go.
            <span class="m-label m-dim">Tab</span> autocompletes common prefix, you can
            copy a link to the result using <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">L</span> while <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">M</span> produces a Markdown link.</p>
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v2.js"></script>
<script src="searchdata-v2.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Taskflow handbook is part of the <a href="https://taskflow.github.io">Taskflow project</a>, copyright © <a href="https://tsung-wei-huang.github.io/">Dr. Tsung-Wei Huang</a>, 2018&ndash;2022.<br />Generated by <a href="https://doxygen.org/">Doxygen</a> 1.8.14 and <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>
